# Smart Trainer (alexhosting.ru) — Отчёт по тестированию живого сайта

**Дата тестирования:** 2026-02-25  
**URL:** https://alexhosting.ru  
**Тестировщик:** Cloud Agent (автоматизированное тестирование через API + анализ фронтенда)  
**Аккаунт:** santex85@gmail.com (user id: 1, Alex Cheremikin)  
**Методология:** Тестирование API-эндпоинтов, анализ HTTP-заголовков, оценка безопасности, производительности и UX

---

## Общая оценка

| Категория | Оценка | Комментарий |
|-----------|--------|-------------|
| Доступность сайта | **9/10** | Сайт работает, быстро отвечает |
| Функциональность API | **7/10** | Основные функции работают, есть дублирование данных и баги |
| Безопасность | **4/10** | Критические проблемы с CORS, нет security headers |
| Производительность | **6/10** | Быстрые API, но JS-бандл не сжат, чат медленный |
| UX/UI | **6/10** | Функциональный MVP, но есть проблемы с навигацией и языком |
| **Итого** | **6.4/10** | Рабочий MVP, требуются доработки безопасности и UX |

---

## 1. Инфраструктура и развёртывание

### Сервер
- **Web-сервер:** nginx/1.29.5 за Caddy reverse proxy
- **SSL:** Let's Encrypt (E8), валиден с 23.02.2026 по 24.05.2026
- **HTTP/2:** Поддерживается
- **Alt-Svc:** h3 (HTTP/3) анонсирован на порт 443

### Архитектура
- **Frontend:** Expo/React Native Web — SPA (Single Page Application)
- **Backend:** FastAPI (Python) — RESTful JSON API
- **Прокси:** Все маршруты `/api/v1/*` проксируются на бэкенд, остальное отдаётся как статика
- **JS-бандл:** 826 KB (один файл `AppEntry-*.js`)

### Замечания
- **robots.txt** — отсутствует (отдаётся HTML главной страницы вместо 404 или реального robots.txt)
- **favicon.ico** — отсутствует (отдаётся HTML главной страницы)
- **/docs, /openapi.json, /redoc** — FastAPI swagger UI не доступны (заслоняются фронтенд-рутингом). Вероятно, бэкенд API-документация скрыта, но это может быть и багом конфигурации nginx

---

## 2. Аутентификация и авторизация

### 2.1 Вход (Login) — PASS
```
POST /api/v1/auth/login
{"email":"santex85@gmail.com","password":"***"}
→ 200 OK, access_token (JWT), user {id: 1, email: ...}
```
- Вход работает корректно
- JWT-токен содержит: `sub: "1"`, `email`, `exp: 1772619562` (срок действия ~30 минут)
- Тип токена: bearer

### 2.2 Проверка авторизации — PASS
```
GET /api/v1/auth/me (без токена) → 401 "Not authenticated"
GET /api/v1/auth/me (невалидный токен) → 401 "Invalid or expired token"
GET /api/v1/auth/me (валидный токен) → 200 {id: 1, email: "santex85@gmail.com"}
```
- Защита эндпоинтов работает корректно

### 2.3 Регистрация — PASS
```
POST /api/v1/auth/register (дублирующий email) → 400 "Email already registered"
```
- Проверка дублирования email работает

### 2.4 Неверный пароль — PASS
```
POST /api/v1/auth/login (неверный пароль) → 401 "Invalid email or password"
```
- Сообщение об ошибке не раскрывает, что именно неверно (email или пароль) — это правильно с точки зрения безопасности

### 2.5 Валидация ввода — PASS
```
POST /api/v1/auth/login ({}) → 422, с перечнем обязательных полей
```
- Pydantic-валидация работает корректно

### 2.6 SQL Injection — PASS
```
POST /api/v1/auth/login (email: 'admin" OR 1=1--') → 401 "Invalid email or password"
```
- SQL-инъекция не работает, ORM защищает

---

## 3. Функциональное тестирование API

### 3.1 Профиль атлета — PASS
```
GET /api/v1/athlete-profile → 200
```
Возвращаемые данные:
- Вес: 76 кг, рост: 170 см, год рождения: 1985, пол: M
- FTP: 160 (источник: manual)
- Strava-профиль: Alex Cheremikin, фото из Google аккаунта
- Strava обновлено: 2026-02-25T03:55:24

### 3.2 Интеграция Intervals.icu — PASS
```
GET /api/v1/intervals/status → 200 {"linked": true, "athlete_id": "i471411"}
POST /api/v1/intervals/sync → 200 {"activities_synced": 24, "wellness_days_synced": 91}
POST /api/v1/intervals/unlink → 200 {"status": "unlinked"}
POST /api/v1/intervals/link → 200 {"status": "linked"}
```
- Все операции работают
- Синхронизация подтягивает 24 активности и 91 день wellness-данных

### 3.3 Тренировки (Workouts) — PASS с замечаниями

```
GET /api/v1/workouts → 200, 4 записи
```

**BUG: Дублирование тренировок.**  
Каждая тренировка присутствует дважды с разными id но идентичным содержимым:

| id | Дата | Название | Тип | Длительность | Дистанция | TSS |
|----|------|----------|-----|-------------|-----------|-----|
| 25 | 2026-02-25 | Morning Заезд | Ride | 97 мин | 41.3 км | 80 |
| 1 | 2026-02-25 | Morning Заезд | Ride | 97 мин | 41.3 км | 80 |
| 26 | 2026-02-24 | Morning Заезд | Ride | 107 мин | 46.7 км | 107 |
| 2 | 2026-02-24 | Morning Заезд | Ride | 107 мин | 46.7 км | 107 |

Предположительно, дублирование возникает при повторной синхронизации с Intervals.icu — дедупликация не работает или работает некорректно (тренировки id 1,2 — старые, id 25,26 — новые после sync).

### 3.4 Фитнес-показатели (CTL/ATL/TSB) — PASS
```
GET /api/v1/workouts/fitness → 200
{"ctl": 24.8, "atl": 23.9, "tsb": 0.9, "date": "2026-02-25"}
```
- CTL (Chronic Training Load): 24.8
- ATL (Acute Training Load): 23.9
- TSB (Training Stress Balance): 0.9
- Атлет близок к балансу, небольшой положительный TSB

### 3.5 Wellness данные — PASS с замечаниями
```
GET /api/v1/wellness → 200, 31 запись (26.01 – 25.02.2026)
```

**Замечание:** Данные о сне, RHR и HRV заполнены только за 25.02.2026:
- sleep_hours: 5.35 (за сегодня)
- rhr: null (за все дни)
- hrv: null (за все дни)

CTL/ATL/TSB рассчитаны корректно — за последние дни видно снижение формы (CTL упал с 38 до 24.8 за месяц), с резким подъёмом 24-25 февраля после двух заездов.

### 3.6 Питание (Nutrition) — PASS с замечаниями
```
POST /api/v1/nutrition/entries (валидные данные) → 200 {id: 21, ...}
POST /api/v1/nutrition/entries ({}) → 422 (список обязательных полей)
```

**Обязательные поля:** name, portion_grams, calories, protein_g, fat_g, carbs_g

**BUG:** Нет GET-метода для получения списка записей питания:
```
GET /api/v1/nutrition/entries?date=2026-02-25 → 405 "Method Not Allowed"
```
Фронтенд, вероятно, получает данные из другого эндпоинта или агрегирует на dashboard. Тем не менее, отсутствие GET-эндпоинта для entries — это пробел в API.

### 3.7 AI-Чат — PASS
```
POST /api/v1/chat/send
{"message": "Привет, как мне использовать приложение?"}
→ 200, ответ AI-тренера
```

AI-ответ качественный и контекстуальный:
- Учитывает реальные данные пользователя (5.35 часа сна, 76 кг, TSS 80/107)
- Даёт конкретные рекомендации по сну, питанию, нагрузке
- Упоминает недостаток белка (52 г при весе 76 кг)
- Сообщает о недостающих данных (RHR, HRV)
- На русском языке

### 3.8 AI-Оркестратор — PARTIAL FAIL
```
POST /api/v1/chat/orchestrator/run
{"message": "Дай мне план тренировок на неделю"}
→ 200, {"decision": "Skip", "reason": "Parse error; defaulting to Skip."}
```

**BUG:** Оркестратор возвращает ошибку парсинга и дефолтится в "Skip" вместо генерации решения. Поля `modified_plan` и `suggestions_next_days` возвращают null. Возможно, проблема в формате ответа от LLM или в парсинге structured output.

### 3.9 Загрузка фото для анализа сна — НЕ ТЕСТИРОВАЛОСЬ
```
POST /api/v1/photo/save-sleep → 405 на GET (только POST)
```
Требует multipart/form-data с изображением — невозможно полноценно протестировать через curl.

---

## 4. Безопасность

### 4.1 CORS — CRITICAL
```
access-control-allow-origin: *
access-control-allow-credentials: true
```

**Критическая уязвимость:** Комбинация `allow-origin: *` и `allow-credentials: true` позволяет любому сайту в интернете отправлять запросы от имени залогиненного пользователя.

**Рекомендация:** Настроить CORS с конкретным origin:
```python
origins = ["https://alexhosting.ru"]
app.add_middleware(CORSMiddleware, allow_origins=origins, allow_credentials=True)
```

### 4.2 Security Headers — FAIL

Ни один из стандартных security headers не установлен:

| Header | Статус | Риск |
|--------|--------|------|
| Strict-Transport-Security (HSTS) | Отсутствует | Возможен downgrade на HTTP |
| X-Frame-Options | Отсутствует | Возможен clickjacking |
| X-Content-Type-Options | Отсутствует | Возможен MIME sniffing |
| Content-Security-Policy | Отсутствует | Возможен XSS |
| Referrer-Policy | Отсутствует | Утечка URL |
| Permissions-Policy | Отсутствует | Нет ограничений API браузера |
| X-XSS-Protection | Отсутствует | Нет legacy XSS-защиты |

**Рекомендация:** Добавить в Caddy/nginx:
```
Strict-Transport-Security: max-age=31536000; includeSubDomains
X-Content-Type-Options: nosniff
X-Frame-Options: DENY
Referrer-Policy: strict-origin-when-cross-origin
```

### 4.3 JWT-безопасность — OK с замечаниями
- Алгоритм HS256 — приемлемо для MVP
- Токен содержит минимально необходимые поля (sub, email, exp)
- Срок действия ~30 минут — приемлемо
- **Замечание:** `sub` хранится как строка `"1"` вместо числа — некритично, но нестандартно
- **Замечание:** Нет refresh token — пользователь будет разлогинен каждые 30 минут

### 4.4 Rate Limiting — НЕ ОБНАРУЖЕН
Не обнаружено ограничение скорости запросов. Возможна brute-force атака на логин.

**Рекомендация:** Добавить rate limiting (например, slowapi для FastAPI):
- Login: максимум 5 попыток в минуту
- API: максимум 60 запросов в минуту

### 4.5 Информация о сервере — MEDIUM
Заголовок `server: nginx/1.29.5` раскрывает версию nginx.

**Рекомендация:** Скрыть версию: `server_tokens off;` в nginx.conf

---

## 5. Производительность

### 5.1 Время загрузки

| Ресурс | Время | Размер | Оценка |
|--------|-------|--------|--------|
| Главная страница (HTML) | 0.28 с | 1.2 KB | Отлично |
| JS-бандл | 0.83 с | 826 KB | Удовлетворительно |
| API: Login | 0.60 с | — | Хорошо |
| API: Workouts | 0.30 с | — | Хорошо |
| API: Wellness | 0.29 с | — | Хорошо |
| API: Fitness | 0.28 с | — | Хорошо |
| API: Chat AI | **9.45 с** | — | Медленно (ожидаемо для LLM) |

### 5.2 Gzip/Brotli-сжатие — FAIL
JS-бандл 826 KB отдаётся **без сжатия**. При gzip-сжатии ожидается ~200-250 KB (~70% экономии).

**Рекомендация:** Включить gzip в nginx:
```nginx
gzip on;
gzip_types application/javascript text/css application/json;
gzip_min_length 256;
```

### 5.3 Кэширование — НЕ ОПТИМАЛЬНО
- HTML: `etag` и `last-modified` присутствуют — OK
- JS-бандл имеет хеш в имени файла (good для cache busting), но нет заголовка `Cache-Control: max-age=...` для долгосрочного кэширования

**Рекомендация:** Добавить для статических файлов с хешем:
```nginx
location /_expo/static/ {
    expires 1y;
    add_header Cache-Control "public, immutable";
}
```

### 5.4 Bundle Size — ЗАМЕЧАНИЕ
826 KB для SPA — это приемлемо, но для мобильного приложения на слабых сетях стоит задуматься о code splitting или lazy loading.

---

## 6. Структура приложения (Frontend)

### 6.1 Навигация
Приложение использует React Navigation с Tab Navigator:
- **Главная** (Home) — дашборд с данными
- **Чат** (Chat) — AI-тренер
- **Профиль** (Profile) — настройки и данные атлета

Также доступны экраны:
- Login / Register — авторизация
- Формы ввода: wellness, nutrition, workouts

### 6.2 Обнаруженные формы ввода (по placeholder'ам)

| Форма | Поля |
|-------|------|
| Wellness | Сон (часы), RHR (уд/мин), HRV (мс) |
| Nutrition | Dish name, Ккал, Белки, Жиры, Углеводы |
| Workout | Название, Тип, Длительность, Дистанция, TSS, Заметки |
| Auth | Email, Пароль |
| Athlete | Вес (кг), Дата (YYYY-MM-DD) |

### 6.3 Язык интерфейса — СМЕШАННЫЙ
- Табы на русском: "Главная", "Чат", "Профиль"
- Placeholder'ы: смесь — "Dish name" (англ.), "Сон (часы)" (рус.)
- Лейблы нутриентов на русском: Ккал, Белки, Жиры, Углеводы

---

## 7. Данные пользователя (состояние)

### Профиль
- Alex Cheremikin, М, 1985 г.р., 76 кг, 170 см, FTP 160
- Strava подключён, Intervals.icu подключён (athlete i471411)

### Тренировочная нагрузка
- Форма: CTL 24.8 (низкая), ATL 23.9, TSB +0.9
- Последний месяц — спад нагрузки (CTL упал с 38 до 24)
- Последние 2 дня — активные заезды (TSS 80 + 107)
- Синхронизировано 24 активности, 91 день wellness

### Питание (по данным чата AI)
- Сегодня: ~1460 ккал, 52 г белка — недостаточно для активного атлета

### Wellness
- Сон за 25.02: 5.35 часа — недостаточно
- RHR/HRV: нет данных ни за один день

---

## 8. Найденные баги

| # | Серьёзность | Описание | Эндпоинт/Место |
|---|------------|----------|----------------|
| 1 | **HIGH** | Дублирование тренировок при синхронизации — одна и та же тренировка записывается дважды с разными ID | `/api/v1/workouts` |
| 2 | **HIGH** | CORS полностью открыт (`*`) с credentials — критическая уязвимость | Все API |
| 3 | **HIGH** | Оркестратор возвращает "Parse error; defaulting to Skip" вместо решения | `/api/v1/chat/orchestrator/run` |
| 4 | **MEDIUM** | Нет GET-метода для получения записей питания | `/api/v1/nutrition/entries` |
| 5 | **MEDIUM** | Нет security headers (HSTS, CSP, X-Frame-Options и т.д.) | HTTP-заголовки |
| 6 | **MEDIUM** | JS-бандл не сжат (gzip/brotli) — 826 KB вместо ~200 KB | nginx конфиг |
| 7 | **LOW** | robots.txt отсутствует (отдаётся HTML) | Статика |
| 8 | **LOW** | favicon.ico отсутствует (отдаётся HTML) | Статика |
| 9 | **LOW** | Версия nginx раскрывается в заголовке Server | HTTP-заголовки |
| 10 | **LOW** | Нет refresh token — сессия истекает каждые ~30 минут | Auth |
| 11 | **LOW** | Смешение русского и английского в интерфейсе | Frontend |

---

## 9. Что работает хорошо

1. **Аутентификация** — логин, регистрация, защита эндпоинтов работают корректно
2. **AI-чат** — отвечает качественно, контекстуально, на русском языке, учитывает реальные данные пользователя
3. **Интеграция Intervals.icu** — связь/отвязка/синхронизация работают
4. **Валидация входных данных** — Pydantic-валидация корректно отклоняет невалидные запросы с подробными ошибками
5. **Защита от SQL-инъекций** — ORM/параметризованные запросы работают
6. **SSL/HTTPS** — валидный сертификат, HTTP/2, HTTP/3
7. **Время отклика API** — быстрые ответы (200-600 мс для данных)
8. **Структура профиля** — полные данные атлета с интеграцией Strava

---

## 10. Рекомендации по приоритету

### Немедленно (Critical)
1. Исправить CORS — заменить `*` на конкретный origin
2. Исправить дублирование тренировок при синхронизации
3. Исправить оркестратор (parse error)

### В ближайшее время (High)
4. Добавить security headers
5. Включить gzip-сжатие
6. Добавить rate limiting на login
7. Добавить GET-метод для nutrition entries

### Плановые улучшения (Medium)
8. Добавить refresh token
9. Унифицировать язык интерфейса
10. Настроить кэширование статики
11. Добавить robots.txt и favicon
12. Скрыть версию nginx

---

## Заключение

**Smart Trainer** на alexhosting.ru представляет собой работающий MVP AI-тренера для велосипедистов/спортсменов. Основная функциональность — авторизация, отображение данных, AI-чат, интеграция с Intervals.icu — работает. AI-чат даёт качественные, персонализированные рекомендации на основе реальных данных пользователя.

Однако есть **три критических проблемы**, которые нужно исправить до выхода в публичное использование:
1. **Открытый CORS** — любой сайт может выполнять запросы от имени пользователя
2. **Дублирование тренировок** — нарушает целостность данных и расчёт нагрузки
3. **Нерабочий оркестратор** — ключевая функция (Go/Modify/Skip решение) не работает

После исправления этих проблем и добавления базовых security headers, приложение будет готово к бета-тестированию.

**Готовность к production: ~60%**
