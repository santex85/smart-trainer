# Анализ: данные сна не попадают в дашборд-анализ

## Текущее состояние

### Источники данных о сне
1. **wellness_cache** — ручной ввод (блок «Сон и здоровье» на дашборде): `sleep_hours`, RHR, HRV.
2. **sleep_extractions** — сохранённые результаты анализа фото сна (скриншоты приложений сна).

### Где используются данные

| Место | wellness_cache | sleep_extractions |
|-------|----------------|-------------------|
| **Дашборд (блок «Сон и здоровье»)** | ✅ за сегодня | ✅ последняя запись за 7 дней (если в wellness нет сна) |
| **Run analysis now (оркестратор)** | ✅ только он | ❌ **не используется** |
| **AI Coach (чат)** | ✅ «Wellness today» | ✅ отдельный блок «Sleep (from photos, last 30 days)» |

## Проблема

**Оркестратор** (`run_daily_decision` в `orchestrator.py`) формирует контекст для решения Go/Modify/Skip **только** из `WellnessCache` за сегодня. Если пользователь вносит сон только через фото (sleep_extractions), в wellness_cache за сегодня записи нет → в контекст попадает пустой `wellness_today` → ИИ не видит сон и принимает решение без учёта сна.

В чате сон из фото есть в отдельной секции, но «Wellness today» при пустом wellness_cache остаётся пустым, поэтому формулировки вроде «Wellness: Данные отсутствуют» могут появляться даже при наличии сна из фото.

## План исправления

1. **Оркестратор**  
   После загрузки `wellness_today` из `WellnessCache`: если за сегодня нет `sleep_hours` (или записи нет), подгрузить последнюю запись из `SleepExtraction` (например, за последние 2–3 дня по `created_at`), взять из `extracted_data` значение `actual_sleep_hours` или `sleep_hours` и подставить в контекст как «сон за сегодня» (например, добавить в `wellness_today` поле `sleep_hours` или отдельное поле `sleep_hours_from_photo`). Так контекст «Run analysis now» всегда будет содержать сон, если он есть хотя бы в sleep_extractions.

2. **Чат (AI Coach)**  
   При сборке блока «Wellness today»: если в wellness_cache за сегодня нет `sleep_hours`, взять последнюю запись из `SleepExtraction` (за последние 1–2 дня) и добавить в блок «Wellness today» поле сна (например, `sleep_hours` из фото), чтобы в одном месте было видно «сон сегодня» и не писать «Wellness: Данные отсутствуют» при наличии сна из фото.

3. **Дашборд**  
   Уже исправлено: сон показывается из wellness или из sleep_extractions + refreshSleepTrigger после сохранения сна из фото.

## Порядок внедрения

1. В `orchestrator.py`: импорт `SleepExtraction`, после блока Wellness за сегодня — запрос последней записи SleepExtraction, обогащение `wellness_today` (sleep_hours из фото при отсутствии в кеше).
2. В `chat.py`: при формировании `wellness_today` для контекста — при отсутствии sleep_hours в кеше подставить сон из последней SleepExtraction в блок «Wellness today».
