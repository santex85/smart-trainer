# –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

## –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ
1. [–û–±–∑–æ—Ä –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã](#–æ–±–∑–æ—Ä-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã)
2. [–ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–º—Ç–æ–≤ (AI)](#–∞–Ω–∞–ª–∏–∑-–ø—Ä–æ–º—Ç–æ–≤-ai)
3. [–í—ã—è–≤–ª–µ–Ω–Ω—ã–µ —É–∑–∫–∏–µ –º–µ—Å—Ç–∞](#–≤—ã—è–≤–ª–µ–Ω–Ω—ã–µ-—É–∑–∫–∏–µ-–º–µ—Å—Ç–∞)
4. [–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É—Å–∫–æ—Ä–µ–Ω–∏—é](#—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏-–ø–æ-—É—Å–∫–æ—Ä–µ–Ω–∏—é)
5. [–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏](#–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã-—Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏)

---

## –û–±–∑–æ—Ä –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

**Smart Trainer** ‚Äî AI-—Ç—Ä–µ–Ω–µ—Ä –¥–ª—è —Å–ø–æ—Ä—Ç—Å–º–µ–Ω–æ–≤ —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è–º–∏:
- **Gemini AI**: –∞–Ω–∞–ª–∏–∑ —Ñ–æ—Ç–æ –µ–¥—ã, –¥–∞–Ω–Ω—ã—Ö —Å–Ω–∞, –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫, —á–∞—Ç
- **Intervals.icu**: wellness, CTL/ATL/TSB, –ø–ª–∞–Ω—ã —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫
- **Strava**: –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏, –ø—Ä–æ—Ñ–∏–ª—å –∞—Ç–ª–µ—Ç–∞
- **PostgreSQL**: —Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

### –û—Å–Ω–æ–≤–Ω—ã–µ AI-—Å–µ—Ä–≤–∏—Å—ã

| –°–µ—Ä–≤–∏—Å | –§–∞–π–ª | –ú–æ–¥–µ–ª—å | –ó–∞–¥–∞—á–∞ |
|--------|------|--------|--------|
| –ê–Ω–∞–ª–∏–∑ –ø–∏—Ç–∞–Ω–∏—è | `gemini_nutrition.py` | gemini-2.0-flash | –ê–Ω–∞–ª–∏–∑ —Ñ–æ—Ç–æ –µ–¥—ã ‚Üí JSON |
| –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è —Ñ–æ—Ç–æ | `gemini_photo_analyzer.py` | gemini-2.0-flash | –ï–¥–∞/–°–æ–Ω + –∞–Ω–∞–ª–∏–∑ |
| –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å–Ω–∞ | `gemini_sleep_parser.py` | gemini-2.0-flash | –°–∫—Ä–∏–Ω—à–æ—Ç —Ç—Ä–µ–∫–µ—Ä–∞ ‚Üí JSON |
| –û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä | `orchestrator.py` | gemini-2.0-flash | Go/Modify/Skip —Ä–µ—à–µ–Ω–∏–µ |
| –ß–∞—Ç —Å —Ç—Ä–µ–Ω–µ—Ä–æ–º | `chat.py` | gemini-2.0-flash | –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ |

---

## –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–º—Ç–æ–≤ (AI)

### 1. –ü—Ä–æ–º—Ç –∞–Ω–∞–ª–∏–∑–∞ –ø–∏—Ç–∞–Ω–∏—è (`gemini_nutrition.py`)

```
–†–∞–∑–º–µ—Ä: ~450 —Å–∏–º–≤–æ–ª–æ–≤
max_output_tokens: 1024
temperature: 0.2
```

**–û—Ü–µ–Ω–∫–∞:** ‚úÖ –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π
- –ö–æ—Ä–æ—Ç–∫–∏–π, —á—ë—Ç–∫–∏–π –ø—Ä–æ–º—Ç
- –°—Ç—Ä–æ–≥–∏–π JSON-—Ñ–æ—Ä–º–∞—Ç
- –ù–µ—Ç –∏–∑–±—ã—Ç–æ—á–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π

### 2. –ü—Ä–æ–º—Ç –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞/–∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä–∞ (`gemini_photo_analyzer.py`)

```
–†–∞–∑–º–µ—Ä: ~2000 —Å–∏–º–≤–æ–ª–æ–≤
max_output_tokens: 4096
temperature: 0.2
```

**–û—Ü–µ–Ω–∫–∞:** ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
- –û–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—ã–π –ø—Ä–æ–º—Ç (–∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è + –∞–Ω–∞–ª–∏–∑) ‚Äî —Ö–æ—Ä–æ—à–æ –¥–ª—è latency
- –°–ª–∏—à–∫–æ–º –¥–µ—Ç–∞–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è sleep (50+ –ø–æ–ª–µ–π)
- –í—ã—Å–æ–∫–∏–π `max_output_tokens` (4096) –ø—Ä–∏ —Ç–∏–ø–∏—á–Ω–æ–º –æ—Ç–≤–µ—Ç–µ ~500-1000 —Ç–æ–∫–µ–Ω–æ–≤

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
```python
# –ë—ã–ª–æ
"max_output_tokens": 4096

# –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è
"max_output_tokens": 2048  # –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –≤—Å–µ—Ö —Å–ª—É—á–∞–µ–≤
```

### 3. –ü—Ä–æ–º—Ç –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Å–Ω–∞ (`gemini_sleep_parser.py`)

```
–†–∞–∑–º–µ—Ä: ~2200 —Å–∏–º–≤–æ–ª–æ–≤
max_output_tokens: 4096
temperature: 0.2
```

**–û—Ü–µ–Ω–∫–∞:** ‚ö†Ô∏è –ò–∑–±—ã—Ç–æ—á–Ω–æ—Å—Ç—å
- –û—á–µ–Ω—å –¥–µ—Ç–∞–ª—å–Ω—ã–π (–Ω—É–∂–µ–Ω –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏)
- –î—É–±–ª–∏—Ä—É–µ—Ç —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª `gemini_photo_analyzer.py`
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è legacy-—ç–Ω–¥–ø–æ–∏–Ω—Ç–∞

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å —Å `gemini_photo_analyzer.py`, —É–¥–∞–ª–∏—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ.

### 4. –ü—Ä–æ–º—Ç –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (`orchestrator.py`)

```
–†–∞–∑–º–µ—Ä –ø—Ä–æ–º—Ç–∞: ~800 —Å–∏–º–≤–æ–ª–æ–≤
–†–∞–∑–º–µ—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞: ~3000-10000 —Å–∏–º–≤–æ–ª–æ–≤ (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç –¥–∞–Ω–Ω—ã—Ö)
max_output_tokens: 2048
temperature: 0.3
```

**–û—Ü–µ–Ω–∫–∞:** ‚ö†Ô∏è –û—Å–Ω–æ–≤–Ω–æ–π bottleneck

**–ü—Ä–æ–±–ª–µ–º—ã:**
1. **–ë–æ–ª—å—à–æ–π –∫–æ–Ω—Ç–µ–∫—Å—Ç** ‚Äî –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –º–Ω–æ–≥–æ –¥–∞–Ω–Ω—ã—Ö:
   - Athlete profile
   - Food today (sum + entries)
   - Wellness today + history (7 –¥–Ω–µ–π)
   - CTL/ATL/TSB
   - Strava activities (14 –¥–Ω–µ–π, –¥–æ 50 –∑–∞–ø–∏—Å–µ–π)
   - Events today

2. **–ú–Ω–æ–≥–æ DB-–∑–∞–ø—Ä–æ—Å–æ–≤** (8+ –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º AI):
   - FoodLog (—Å—É–º–º–∞)
   - FoodLog (entries)
   - WellnessCache (today)
   - SleepExtraction (latest)
   - User email
   - AthleteProfile
   - WellnessCache (history 7 days)
   - StravaActivity (14 days)
   - IntervalsCredentials + API call

### 5. –ü—Ä–æ–º—Ç —á–∞—Ç–∞ (`chat.py`)

```
–†–∞–∑–º–µ—Ä –ø—Ä–æ–º—Ç–∞: ~150 —Å–∏–º–≤–æ–ª–æ–≤
–†–∞–∑–º–µ—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞: ~5000-15000 —Å–∏–º–≤–æ–ª–æ–≤
```

**–û—Ü–µ–Ω–∫–∞:** ‚ö†Ô∏è –ü–æ—Ö–æ–∂–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –∫–∞–∫ —É –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä–∞

**–ü—Ä–æ–±–ª–µ–º—ã:**
1. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ `_build_athlete_context()` ‚âà `_build_context()` –≤ –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä–µ
2. –ï—â—ë –±–æ–ª—å—à–µ –¥–∞–Ω–Ω—ã—Ö (30 –¥–Ω–µ–π —Å–Ω–∞, 14 –¥–Ω–µ–π wellness)
3. –ù–µ—Ç —Å—Ç—Ä–∏–º–∏–Ω–≥–∞ ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∂–¥—ë—Ç –ø–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç

---

## –í—ã—è–≤–ª–µ–Ω–Ω—ã–µ —É–∑–∫–∏–µ –º–µ—Å—Ç–∞

### üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ (High Impact)

#### 1. –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ DB-–∑–∞–ø—Ä–æ—Å—ã
**–ü—Ä–æ–±–ª–µ–º–∞:** 8-10 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ–¥ AI-–≤—ã–∑–æ–≤–æ–º.

**–¢–µ–∫—É—â–∏–π –∫–æ–¥ (orchestrator.py):**
```python
# –ó–∞–ø—Ä–æ—Å 1
r = await session.execute(select(FoodLog.calories...).where(...))
# –ó–∞–ø—Ä–æ—Å 2
r = await session.execute(select(WellnessCache).where(...))
# –ó–∞–ø—Ä–æ—Å 3
r = await session.execute(select(SleepExtraction...).where(...))
# ... –∏ —Ç–∞–∫ –¥–∞–ª–µ–µ
```

**–í–ª–∏—è–Ω–∏–µ:** +200-500ms –∫ –∫–∞–∂–¥–æ–º—É –≤—ã–∑–æ–≤—É –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä–∞/—á–∞—Ç–∞.

#### 2. –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π AI-–≤—ã–∑–æ–≤
**–ü—Ä–æ–±–ª–µ–º–∞:** `model.generate_content()` –±–ª–æ–∫–∏—Ä—É–µ—Ç event loop.

**–í–ª–∏—è–Ω–∏–µ:** –ü—Ä–∏ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ ‚Äî –¥–µ–≥—Ä–∞–¥–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.

#### 3. –ò–∑–±—ã—Ç–æ—á–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è AI
**–ü—Ä–æ–±–ª–µ–º–∞:** –í –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –±–æ–ª—å—à–µ –¥–∞–Ω–Ω—ã—Ö, —á–µ–º –Ω—É–∂–Ω–æ.

**–ü—Ä–∏–º–µ—Ä:** 50 Strava-–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π –∑–∞ 14 –¥–Ω–µ–π —Å –ø–æ–ª–Ω—ã–º–∏ –¥–µ—Ç–∞–ª—è–º–∏ (~5000 —Ç–æ–∫–µ–Ω–æ–≤), –∫–æ–≥–¥–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ 7-10 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö (~500 —Ç–æ–∫–µ–Ω–æ–≤).

### üü° –°—Ä–µ–¥–Ω–∏–µ (Medium Impact)

#### 4. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
- Wellness history –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –≤—ã–∑–æ–≤–µ
- Athlete profile –Ω–µ –∫—ç—à–∏—Ä—É–µ—Ç—Å—è
- Strava activities –ø–µ—Ä–µ–∑–∞–ø—Ä–∞—à–∏–≤–∞—é—Ç—Å—è

#### 5. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞
- `_build_context()` –≤ `orchestrator.py`
- `_build_athlete_context()` –≤ `chat.py`
- –ü–æ—á—Ç–∏ –∏–¥–µ–Ω—Ç–∏—á–Ω–∞—è –ª–æ–≥–∏–∫–∞, —Ä–∞–∑–Ω—ã–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

#### 6. Image resize ‚Äî CPU-bound –æ–ø–µ—Ä–∞—Ü–∏—è
**–ü—Ä–æ–±–ª–µ–º–∞:** `resize_image_for_ai()` –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –≤ async endpoint.

### üü¢ –ù–∏–∑–∫–∏–µ (Low Impact)

#### 7. JSON-–ø–∞—Ä—Å–∏–Ω–≥ —Å fallback
**–ü—Ä–æ–±–ª–µ–º–∞:** `_parse_sleep_json()` –ø—Ä–æ–±—É–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –ø–∞—Ä—Å–∏–Ω–≥–∞.

**–í–ª–∏—è–Ω–∏–µ:** –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ (~1-5ms).

---

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É—Å–∫–æ—Ä–µ–Ω–∏—é

### 1. –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ DB-–∑–∞–ø—Ä–æ—Å—ã

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –í—ã—Å–æ–∫–∏–π  
**–û–∂–∏–¥–∞–µ–º–æ–µ —É—Å–∫–æ—Ä–µ–Ω–∏–µ:** 200-400ms  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –ù–∏–∑–∫–∞—è

```python
# –ë—ã–ª–æ (–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ)
food_sum = await session.execute(...)
wellness = await session.execute(...)
profile = await session.execute(...)

# –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è (–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ)
import asyncio

async def run_daily_decision(...):
    # –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
    food_task = session.execute(select(FoodLog...).where(...))
    wellness_task = session.execute(select(WellnessCache).where(...))
    profile_task = session.execute(select(AthleteProfile).where(...))
    strava_task = session.execute(select(StravaActivity...).where(...))
    
    food_r, wellness_r, profile_r, strava_r = await asyncio.gather(
        food_task, wellness_task, profile_task, strava_task
    )
```

### 2. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ AI

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –í—ã—Å–æ–∫–∏–π  
**–û–∂–∏–¥–∞–µ–º–æ–µ —É—Å–∫–æ—Ä–µ–Ω–∏–µ:** 100-300ms (–º–µ–Ω—å—à–µ —Ç–æ–∫–µ–Ω–æ–≤ = –±—ã—Å—Ç—Ä–µ–µ)  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –°—Ä–µ–¥–Ω—è—è

#### 2.1 –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å Strava activities

```python
# –ë—ã–ª–æ
.limit(50)  # 50 –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π –∑–∞ 14 –¥–Ω–µ–π

# –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è
.limit(10)  # –ü–æ—Å–ª–µ–¥–Ω–∏–µ 10 –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è —Ä–µ—à–µ–Ω–∏—è

# –ò–ª–∏ –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
strava_activities = [
    {
        "date": d.isoformat(),
        "type": act_type,
        "tss": tss,
        "duration_min": moving_sec // 60 if moving_sec else None,
    }
    for row in r_strava.all()
]
```

#### 2.2 –ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞—Ç—å wellness history

```python
# –ë—ã–ª–æ: –ø–æ–ª–Ω—ã–π JSON –≤—Å–µ—Ö 7 –¥–Ω–µ–π
wellness_history = [{"date": ..., "sleep_hours": ..., "rhr": ..., ...}, ...]

# –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è: –∞–≥—Ä–µ–≥–∞—Ç—ã
wellness_summary = {
    "avg_sleep_7d": 7.2,
    "avg_hrv_7d": 45,
    "trend_sleep": "stable",  # improving/stable/declining
    "min_sleep_7d": 5.5,
}
```

#### 2.3 –£–±—Ä–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ food_sum –∏ food_entries

```python
# –ë—ã–ª–æ: –∏ —Å—É–º–º–∞, –∏ —Å–ø–∏—Å–æ–∫
"## Food today (sum)", json.dumps(food_sum),
"## Food today (entries)", json.dumps(food_entries),

# –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è: —Ç–æ–ª—å–∫–æ —Å—É–º–º–∞ (–∏–ª–∏ –∫—Ä–∞—Ç–∫–∏–π —Å–ø–∏—Å–æ–∫)
"## Food today",
f"Total: {food_sum['calories']:.0f} kcal, {food_sum['protein_g']:.0f}g protein"
```

### 3. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° –°—Ä–µ–¥–Ω–∏–π  
**–û–∂–∏–¥–∞–µ–º–æ–µ —É—Å–∫–æ—Ä–µ–Ω–∏–µ:** 50-200ms  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –°—Ä–µ–¥–Ω—è—è

#### 3.1 In-memory cache –¥–ª—è wellness history

```python
from functools import lru_cache
from datetime import date, timedelta
import asyncio

# Redis –∏–ª–∏ in-memory cache
_wellness_cache: dict[tuple[int, date], dict] = {}

async def get_cached_wellness_summary(session, user_id: int, today: date) -> dict:
    cache_key = (user_id, today)
    if cache_key in _wellness_cache:
        return _wellness_cache[cache_key]
    
    # Fetch and compute
    summary = await _compute_wellness_summary(session, user_id, today)
    _wellness_cache[cache_key] = summary
    return summary
```

#### 3.2 –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π —Ä–∞—Å—á—ë—Ç (background job)

```python
# –í scheduler (main.py)
async def precompute_daily_context():
    """Run at 06:00 before orchestrator runs at 07:00"""
    async with async_session_maker() as session:
        for user in await get_all_users(session):
            await precompute_user_context(session, user.id)

scheduler.add_job(precompute_daily_context, "cron", hour=6, minute=0)
```

### 4. –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π Gemini-–≤—ã–∑–æ–≤

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° –°—Ä–µ–¥–Ω–∏–π  
**–û–∂–∏–¥–∞–µ–º–æ–µ —É—Å–∫–æ—Ä–µ–Ω–∏–µ:** –£–ª—É—á—à–µ–Ω–∏–µ throughput –ø—Ä–∏ –Ω–∞–≥—Ä—É–∑–∫–µ  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –ù–∏–∑–∫–∞—è

```python
# –ë—ã–ª–æ (sync –≤ async —Ñ—É–Ω–∫—Ü–∏–∏)
response = model.generate_content(contents)

# –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è (async)
response = await asyncio.to_thread(model.generate_content, contents)

# –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å async API (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ –≤ google-generativeai)
response = await model.generate_content_async(contents)
```

### 5. Image resize –≤ thread pool

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü¢ –ù–∏–∑–∫–∏–π  
**–û–∂–∏–¥–∞–µ–º–æ–µ —É—Å–∫–æ—Ä–µ–Ω–∏–µ:** 50-100ms  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –ù–∏–∑–∫–∞—è

```python
# –ë—ã–ª–æ
image_bytes = resize_image_for_ai(image_bytes)

# –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è
import asyncio
from concurrent.futures import ThreadPoolExecutor

_executor = ThreadPoolExecutor(max_workers=4)

async def resize_image_async(image_bytes: bytes) -> bytes:
    loop = asyncio.get_event_loop()
    return await loop.run_in_executor(_executor, resize_image_for_ai, image_bytes)

# –í endpoint
image_bytes = await resize_image_async(image_bytes)
```

### 6. –°—Ç—Ä–∏–º–∏–Ω–≥ –æ—Ç–≤–µ—Ç–æ–≤ —á–∞—Ç–∞

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° –°—Ä–µ–¥–Ω–∏–π  
**–û–∂–∏–¥–∞–µ–º–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ:** UX (perceived latency)  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –°—Ä–µ–¥–Ω—è—è

```python
from fastapi.responses import StreamingResponse

@router.post("/send-stream")
async def send_message_stream(...):
    async def generate():
        response = model.generate_content(prompt, stream=True)
        for chunk in response:
            yield f"data: {json.dumps({'text': chunk.text})}\n\n"
    
    return StreamingResponse(generate(), media_type="text/event-stream")
```

### 7. –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ context builders

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü¢ –ù–∏–∑–∫–∏–π  
**–û–∂–∏–¥–∞–µ–º–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ:** Maintainability  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –ù–∏–∑–∫–∞—è

```python
# –ù–æ–≤—ã–π —Ñ–∞–π–ª: app/services/context_builder.py

async def build_athlete_context(
    session: AsyncSession,
    user_id: int,
    today: date,
    include_food_entries: bool = True,
    include_strava: bool = True,
    strava_limit: int = 10,
    wellness_days: int = 7,
    sleep_days: int = 30,
) -> dict:
    """–ï–¥–∏–Ω—ã–π builder –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–ª—è –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∏ —á–∞—Ç–∞."""
    # –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
    results = await asyncio.gather(
        _fetch_food_data(session, user_id, today, include_food_entries),
        _fetch_wellness_data(session, user_id, today, wellness_days),
        _fetch_athlete_profile(session, user_id),
        _fetch_strava_activities(session, user_id, today, strava_limit) if include_strava else None,
    )
    return {
        "food": results[0],
        "wellness": results[1],
        "profile": results[2],
        "strava": results[3],
    }
```

### 8. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–º—Ç–æ–≤

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° –°—Ä–µ–¥–Ω–∏–π  
**–û–∂–∏–¥–∞–µ–º–æ–µ —É—Å–∫–æ—Ä–µ–Ω–∏–µ:** 50-150ms  

#### 8.1 –°–æ–∫—Ä–∞—Ç–∏—Ç—å max_output_tokens

```python
# gemini_photo_analyzer.py
GENERATION_CONFIG = {
    "max_output_tokens": 2048,  # –±—ã–ª–æ 4096
}

# orchestrator.py  
GENERATION_CONFIG = {
    "max_output_tokens": 1024,  # –±—ã–ª–æ 2048, –æ—Ç–≤–µ—Ç –æ–±—ã—á–Ω–æ ~200-400 —Ç–æ–∫–µ–Ω–æ–≤
}
```

#### 8.2 –°–æ–∫—Ä–∞—Ç–∏—Ç—å system prompt –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä–∞

```python
# –ë—ã–ª–æ (~800 —Å–∏–º–≤–æ–ª–æ–≤, –º–Ω–æ–≥–æ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π)
SYSTEM_PROMPT = """You are a sports physiologist coach..."""

# –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è (~400 —Å–∏–º–≤–æ–ª–æ–≤)
SYSTEM_PROMPT = """Sports coach. Task: decide Go/Modify/Skip for today's workout.

Rules:
- Level 1 (blocks hard training): poor sleep/HRV/RHR, calorie deficit
- Level 2 (adjusts intensity): TSS, CTL, ATL
- Level 3 (diagnostic): prefer polarised, avoid Zone 3

Output JSON only:
{"decision":"Go|Modify|Skip","reason":"...","modified_plan":null|{...},"suggestions_next_days":null|"..."}"""
```

---

## –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –§–∞–∑–∞ 1: Quick Wins (1-2 –¥–Ω—è)

| # | –ó–∞–¥–∞—á–∞ | –£—Å–∫–æ—Ä–µ–Ω–∏–µ | –°–ª–æ–∂–Ω–æ—Å—Ç—å |
|---|--------|-----------|-----------|
| 1 | –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ DB-–∑–∞–ø—Ä–æ—Å—ã –≤ orchestrator | 200-400ms | –ù–∏–∑–∫–∞—è |
| 2 | –£–º–µ–Ω—å—à–∏—Ç—å strava_limit –¥–æ 10 | 50-100ms | –¢—Ä–∏–≤–∏–∞–ª—å–Ω–∞—è |
| 3 | –£–º–µ–Ω—å—à–∏—Ç—å max_output_tokens | 50-100ms | –¢—Ä–∏–≤–∏–∞–ª—å–Ω–∞—è |
| 4 | Image resize –≤ thread pool | 50-100ms | –ù–∏–∑–∫–∞—è |

**–ò—Ç–æ–≥–æ –§–∞–∑–∞ 1:** ~350-700ms —É—Å–∫–æ—Ä–µ–Ω–∏–µ

### –§–∞–∑–∞ 2: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è (3-5 –¥–Ω–µ–π)

| # | –ó–∞–¥–∞—á–∞ | –£—Å–∫–æ—Ä–µ–Ω–∏–µ | –°–ª–æ–∂–Ω–æ—Å—Ç—å |
|---|--------|-----------|-----------|
| 5 | –ê–≥—Ä–µ–≥–∞—Ü–∏—è wellness/strava –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ | 100-200ms | –°—Ä–µ–¥–Ω—è—è |
| 6 | –ï–¥–∏–Ω—ã–π context builder | Maintainability | –°—Ä–µ–¥–Ω—è—è |
| 7 | –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ wellness summary | 50-100ms | –°—Ä–µ–¥–Ω—è—è |
| 8 | Async Gemini calls | Throughput | –ù–∏–∑–∫–∞—è |

### –§–∞–∑–∞ 3: UX —É–ª—É—á—à–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

| # | –ó–∞–¥–∞—á–∞ | –£–ª—É—á—à–µ–Ω–∏–µ | –°–ª–æ–∂–Ω–æ—Å—Ç—å |
|---|--------|-----------|-----------|
| 9 | –°—Ç—Ä–∏–º–∏–Ω–≥ –æ—Ç–≤–µ—Ç–æ–≤ —á–∞—Ç–∞ | Perceived latency | –°—Ä–µ–¥–Ω—è—è |
| 10 | Background precompute | -200ms –≤ –ø–∏–∫–µ | –í—ã—Å–æ–∫–∞—è |

---

## –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è

```python
# –î–æ–±–∞–≤–∏—Ç—å –≤ app/middleware/timing.py
import time
import logging

logger = logging.getLogger("performance")

async def log_endpoint_timing(request, call_next):
    start = time.perf_counter()
    response = await call_next(request)
    duration_ms = (time.perf_counter() - start) * 1000
    logger.info(
        "endpoint=%s method=%s duration_ms=%.1f",
        request.url.path, request.method, duration_ms
    )
    return response
```

**–ö–ª—é—á–µ–≤—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:**
- `POST /api/v1/photo/analyze` ‚Äî —Ü–µ–ª–µ–≤–æ–µ –≤—Ä–µ–º—è: <3s
- `POST /api/v1/chat/send` ‚Äî —Ü–µ–ª–µ–≤–æ–µ –≤—Ä–µ–º—è: <2s
- `POST /api/v1/chat/orchestrator/run` ‚Äî —Ü–µ–ª–µ–≤–æ–µ –≤—Ä–µ–º—è: <2s

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–û—Å–Ω–æ–≤–Ω—ã–µ bottlenecks –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏:

1. **–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ DB-–∑–∞–ø—Ä–æ—Å—ã** ‚Äî —Ä–µ—à–∞–µ—Ç—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–∞—Ü–∏–µ–π (asyncio.gather)
2. **–ò–∑–±—ã—Ç–æ—á–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç AI** ‚Äî —Ä–µ—à–∞–µ—Ç—Å—è –∞–≥—Ä–µ–≥–∞—Ü–∏–µ–π –∏ –ª–∏–º–∏—Ç–∞–º–∏
3. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è** ‚Äî —Ä–µ—à–∞–µ—Ç—Å—è in-memory –∏–ª–∏ Redis cache

–û–∂–∏–¥–∞–µ–º–æ–µ —Å—É–º–º–∞—Ä–Ω–æ–µ —É—Å–∫–æ—Ä–µ–Ω–∏–µ –ø–æ—Å–ª–µ –§–∞–∑—ã 1+2: **500-1000ms** (30-50% –±—ã—Å—Ç—Ä–µ–µ).

–ú–æ–¥–µ–ª—å `gemini-2.0-flash` ‚Äî –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –≤—ã–±–æ—Ä –¥–ª—è –±–∞–ª–∞–Ω—Å–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏ –∏ –∫–∞—á–µ—Å—Ç–≤–∞. –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –±–æ–ª–µ–µ –±—ã—Å—Ç—Ä—É—é –º–æ–¥–µ–ª—å (–µ—Å–ª–∏ –ø–æ—è–≤–∏—Ç—Å—è) –¥–∞—Å—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–∏—Ä–æ—Å—Ç.
