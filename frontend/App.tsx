import * as Sentry from "@sentry/react-native";

Sentry.init({
  dsn: process.env.EXPO_PUBLIC_SENTRY_DSN || "",
  enabled: !!process.env.EXPO_PUBLIC_SENTRY_DSN,
  tracesSampleRate: 0.2,
  environment: process.env.EXPO_PUBLIC_APP_ENV || "development",
});

import React, { useEffect, useState } from "react";
import { View, StyleSheet, Text, ActivityIndicator, Platform, Pressable } from "react-native";
import { StatusBar } from "expo-status-bar";
import { SafeAreaProvider } from "react-native-safe-area-context";
import { NavigationContainer, createNavigationContainerRef } from "@react-navigation/native";
import { createNativeStackNavigator } from "@react-navigation/native-stack";
import { createBottomTabNavigator } from "@react-navigation/bottom-tabs";
import { flushOfflineMutations, getMe, savePushToken, setOnUnauthorized, syncIntervals } from "./src/api/client";
import { registerForPushTokenAsync } from "./src/utils/pushNotifications";
import { clearAuth, getAccessToken } from "./src/storage/authStorage";
import { ThemeProvider, useTheme } from "./src/theme";
import { QueryProvider } from "./src/query/provider";
import { DashboardScreen } from "./src/screens/DashboardScreen";
import { LoginScreen } from "./src/screens/LoginScreen";
import { RegisterScreen } from "./src/screens/RegisterScreen";
import { CameraScreen } from "./src/screens/CameraScreen";
import { ChatScreen } from "./src/screens/ChatScreen";
import { AthleteProfileScreen } from "./src/screens/AthleteProfileScreen";
import { AnalyticsScreen } from "./src/screens/AnalyticsScreen";
import { IntervalsLinkScreen } from "./src/screens/IntervalsLinkScreen";
import { PricingScreen } from "./src/screens/PricingScreen";
import type { AuthUser } from "./src/api/client";
import { t } from "./src/i18n";
import { Ionicons } from "@expo/vector-icons";

const Stack = createNativeStackNavigator();
const Tab = createBottomTabNavigator();
const navigationRef = createNavigationContainerRef();

function AppContent() {
  const { colors, mode } = useTheme();
  const [user, setUser] = useState<AuthUser | null>(null);
  const [isReady, setIsReady] = useState(false);
  const [cameraVisible, setCameraVisible] = useState(false);
  const [intervalsVisible, setIntervalsVisible] = useState(false);
  const [pricingVisible, setPricingVisible] = useState(false);
  const [refreshNutritionTrigger, setRefreshNutritionTrigger] = useState(0);
  const [refreshSleepTrigger, setRefreshSleepTrigger] = useState(0);
  const [refreshWellnessTrigger, setRefreshWellnessTrigger] = useState(0);

  useEffect(() => {
    setOnUnauthorized(() => {
      clearAuth();
      setUser(null);
    });
  }, []);

  useEffect(() => {
    getAccessToken()
      .then((token) => {
        if (token) return getMe().then(setUser).catch(() => setUser(null));
        setUser(null);
      })
      .finally(() => setIsReady(true));
  }, []);

  useEffect(() => {
    if (!user) return;
    flushOfflineMutations().catch(() => {});
    registerForPushTokenAsync()
      .then((token) => {
        if (token) return savePushToken(token, Platform.OS);
      })
      .catch(() => {});
  }, [user]);

  const closeCamera = () => {
    setCameraVisible(false);
    setRefreshNutritionTrigger((t) => t + 1);
  };

  const handleLogout = async () => {
    await clearAuth();
    setUser(null);
  };

  if (!isReady) {
    return (
      <SafeAreaProvider>
        <View style={[styles.root, styles.centered, { backgroundColor: colors.background }]}>
          <ActivityIndicator size="large" color={colors.primary} />
          <Text style={[styles.loadingText, { color: colors.textMuted }]}>{t("app.loading")}</Text>
        </View>
      </SafeAreaProvider>
    );
  }

  if (!user) {
    return (
      <SafeAreaProvider>
        <StatusBar style={mode === "dark" ? "light" : "dark"} />
        <View style={[styles.root, { backgroundColor: colors.background }]}>
          <NavigationContainer>
            <Stack.Navigator
              screenOptions={{
                headerShown: false,
                contentStyle: { backgroundColor: colors.background },
                animation: "fade_from_bottom",
                animationDuration: 200,
              }}
            >
              <Stack.Screen name="Login">
                {({ navigation }) => (
                  <LoginScreen
                    onSuccess={setUser}
                    onGoToRegister={() => navigation.navigate("Register")}
                  />
                )}
              </Stack.Screen>
              <Stack.Screen name="Register">
                {({ navigation }) => (
                  <RegisterScreen
                    onSuccess={setUser}
                    onGoToLogin={() => navigation.goBack()}
                  />
                )}
              </Stack.Screen>
            </Stack.Navigator>
          </NavigationContainer>
        </View>
      </SafeAreaProvider>
    );
  }

  return (
    <SafeAreaProvider>
      <StatusBar style={mode === "dark" ? "light" : "dark"} />
      <View style={[styles.root, { backgroundColor: colors.background }]}>
        <NavigationContainer ref={navigationRef}>
          <Tab.Navigator
            screenOptions={({ route }) => {
              const getIconName = (outline: string, filled: string, focused: boolean) =>
                focused ? filled : outline;
              return {
                headerShown: false,
                tabBarIcon: ({ focused, color, size }) => {
                  let iconName: string;
                  switch (route.name) {
                    case "Home":
                      iconName = getIconName("home-outline", "home", focused);
                      break;
                    case "Chat":
                      iconName = getIconName("chatbubbles-outline", "chatbubbles", focused);
                      break;
                    case "Analytics":
                      iconName = getIconName("stats-chart-outline", "stats-chart", focused);
                      break;
                    case "Profile":
                      iconName = getIconName("person-outline", "person", focused);
                      break;
                    default:
                      iconName = "ellipse-outline";
                  }
                  return <Ionicons name={iconName as any} size={size} color={color} />;
                },
                tabBarStyle: {
                  backgroundColor: colors.glassBg,
                  borderTopWidth: 1,
                  borderTopColor: colors.glassBorder,
                  borderTopLeftRadius: colors.borderRadiusLg,
                  borderTopRightRadius: colors.borderRadiusLg,
                  ...(Platform.OS === "web" ? { backdropFilter: "blur(20px)" as any } : {}),
                },
                tabBarActiveTintColor: colors.tabActive,
                tabBarInactiveTintColor: colors.tabInactive,
                animation: "fade",
              };
            }}
          >
            <Tab.Screen
              name="Home"
              options={{ tabBarLabel: t("tabs.home") }}
            >
              {({ navigation }) => (
                <DashboardScreen
                  user={user}
                  onLogout={handleLogout}
                  onOpenCamera={() => setCameraVisible(true)}
                  onOpenChat={() => navigation.navigate("Chat")}
                  onOpenAthleteProfile={() => navigation.navigate("Profile")}
                  onOpenIntervals={() => setIntervalsVisible(true)}
                  onOpenPricing={() => setPricingVisible(true)}
                  onSyncIntervals={async () => {
                    const result = await syncIntervals();
                    setRefreshWellnessTrigger((t) => t + 1);
                    return result;
                  }}
                  refreshNutritionTrigger={refreshNutritionTrigger}
                  refreshSleepTrigger={refreshSleepTrigger}
                  refreshWellnessTrigger={refreshWellnessTrigger}
                />
              )}
            </Tab.Screen>
            <Tab.Screen
              name="Chat"
              options={{ tabBarLabel: t("tabs.chat") }}
            >
              {({ navigation }) => (
                <ChatScreen onClose={() => navigation.navigate("Home")} onOpenPricing={() => setPricingVisible(true)} />
              )}
            </Tab.Screen>
            <Tab.Screen
              name="Analytics"
              options={{ tabBarLabel: t("tabs.analytics") }}
            >
              {({ navigation }) => (
                <AnalyticsScreen onClose={() => navigation.navigate("Home")} onOpenPricing={() => setPricingVisible(true)} />
              )}
            </Tab.Screen>
            <Tab.Screen
              name="Profile"
              options={{ tabBarLabel: t("tabs.profile") }}
            >
              {({ navigation }) => (
                <AthleteProfileScreen onClose={() => navigation.navigate("Home")} onOpenPricing={() => setPricingVisible(true)} />
              )}
            </Tab.Screen>
          </Tab.Navigator>
        </NavigationContainer>

        {cameraVisible && (
          <View style={[styles.modal, { backgroundColor: colors.background }]}>
            <CameraScreen
              onClose={closeCamera}
              onOpenPricing={() => setPricingVisible(true)}
              onSaved={() => {
                setRefreshNutritionTrigger((t) => t + 1);
                setCameraVisible(false);
              }}
              onSleepSaved={() => {
                setRefreshSleepTrigger((t) => t + 1);
                setCameraVisible(false);
              }}
              onWellnessSaved={() => {
                setRefreshSleepTrigger((t) => t + 1);
                setCameraVisible(false);
              }}
            />
          </View>
        )}

        {intervalsVisible && (
          <View style={[styles.modal, { backgroundColor: colors.background }]}>
            <IntervalsLinkScreen
              onClose={() => setIntervalsVisible(false)}
              onSynced={() => setRefreshWellnessTrigger((t) => t + 1)}
            />
          </View>
        )}

        {pricingVisible && (
          <View style={[styles.modal, { backgroundColor: colors.background }]}>
            <PricingScreen onClose={() => setPricingVisible(false)} />
          </View>
        )}

      </View>
    </SafeAreaProvider>
  );
}

function ErrorFallback({
  error,
  resetError,
}: {
  error: Error;
  resetError: () => void;
}) {
  const { colors } = useTheme();
  return (
    <View style={[styles.root, styles.centered, { backgroundColor: colors.background }]}>
      <Text style={[styles.loadingText, { color: colors.text }]}>{t("app.errorBoundary")}</Text>
      <Pressable
        onPress={resetError}
        style={({ pressed }) => [
          { marginTop: 16, paddingVertical: 10, paddingHorizontal: 20, backgroundColor: colors.primary, borderRadius: 8, opacity: pressed ? 0.8 : 1 },
        ]}
      >
        <Text style={{ color: "#fff", fontWeight: "600" }}>{t("app.errorBoundaryBack")}</Text>
      </Pressable>
    </View>
  );
}

function App() {
  return (
    <QueryProvider>
      <ThemeProvider>
        <Sentry.ErrorBoundary fallback={({ error, resetError }) => <ErrorFallback error={error} resetError={resetError} />}>
          <AppContent />
        </Sentry.ErrorBoundary>
      </ThemeProvider>
    </QueryProvider>
  );
}

export default Sentry.wrap(App);

const styles = StyleSheet.create({
  root: { flex: 1 },
  centered: { justifyContent: "center", alignItems: "center", gap: 12 },
  loadingText: { fontSize: 14 },
  modal: { ...StyleSheet.absoluteFillObject, zIndex: 10 },
});
